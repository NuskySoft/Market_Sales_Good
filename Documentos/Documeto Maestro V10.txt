# ğŸ“„ **DOCUMENTO MAESTRO V10 - MARKET SALES**

## ğŸ“± **INFORMACIÃ“N DEL PROYECTO**

### **Nombre del Proyecto:** Market Sales
### **Package Name:** es.nuskysoftware.marketsales
### **Estado Actual:** ğŸ”„ **V10 - REFACTORIZACIÃ“N MONOUSUARIO SIMPLIFICADA**

---

## ğŸš¨ **CAMBIOS CRÃTICOS V10 - NUEVA ARQUITECTURA MONOUSUARIO**

### **ğŸ“‹ CAMBIOS FUNDAMENTALES:**
- âŒ **Eliminado sistema multiusuario** - Arquitectura simplificada
- âœ… **App monousuario** - Un usuario logueado o usuario_default
- âœ… **ConfiguraciÃ³n global** - Moneda, idioma, fuente y tema comunes
- âœ… **Solo Premium diferencia** - Ãšnico dato especÃ­fico por usuario
- âœ… **Datos por usuario** - Todas las tablas (mercadillos, artÃ­culos, etc.)
- âœ… **SincronizaciÃ³n mejorada** - Timestamp + versionado para conflictos

---

## ğŸ—‘ï¸ **ARCHIVOS OBSOLETOS IDENTIFICADOS**

### **Archivos a ELIMINAR:**
```
âŒ MenuLateral.kt - No se usa (confirmado en cÃ³digo)
âŒ UserManager.kt - GestiÃ³n multiusuario obsoleta
```

### **Archivos a MANTENER pero SIMPLIFICAR:**
```
âœ… UserRepository.kt - MANTENER (para gestiÃ³n de usuarios registrados)
âœ… UserDao.kt - MANTENER (para datos de usuarios)
âœ… UserEntity.kt - MANTENER pero SIMPLIFICAR (sin empresas/roles)
```

### **Archivos a REFACTORIZAR:**
```
ğŸ”„ AuthRepository.kt - Simplificar sin sistema multiusuario
ğŸ”„ ConfigurationManager.kt - Remover campos de empresas/roles
ğŸ”„ AppDatabase.kt - Eliminar tabla usuarios, actualizar a v5
ğŸ”„ ConfiguracionEntity.kt - Agregar campos de sincronizaciÃ³n
ğŸ”„ MercadilloEntity.kt - Agregar campos version/lastModified
```

---

## âœ… **NUEVA ARQUITECTURA V10**

### **ğŸ¯ CONFIGURACIÃ“N SIMPLIFICADA:**

#### **Tabla `configuracion` (GLOBAL - ComÃºn a todos):**
```kotlin
@Entity(tableName = "configuracion")
data class ConfiguracionEntity(
    @PrimaryKey val id: Int = 1,
    
    // CONFIGURACIÃ“N GLOBAL (comÃºn a todos los usuarios)
    val moneda: String = "â‚¬ Euro",        
    val idioma: String = "es",            
    val fuente: String = "Montserrat",    
    val temaOscuro: Boolean = false,      
    
    // USUARIO ACTUAL LOGUEADO
    val usuarioLogueado: String? = null,  // UID del usuario actual o null
    
    // SINCRONIZACIÃ“N
    val version: Long = 1,
    val lastModified: Long = System.currentTimeMillis(),
    val pendienteSync: Boolean = false
)
```

#### **Tabla `usuarios` (SIMPLIFICADA - Solo datos bÃ¡sicos):**
```kotlin
@Entity(tableName = "usuarios")
data class UserEntity(
    @PrimaryKey val uid: String,          // Firebase UID
    val email: String,                    // Email del usuario
    val displayName: String = "",         // Nombre del usuario
    val photoUrl: String = "",            // URL foto perfil
    val esPremium: Boolean = false,       // ÃšNICO dato especÃ­fico por usuario
    
    // SINCRONIZACIÃ“N
    val version: Long = 1,
    val lastModified: Long = System.currentTimeMillis(),
    val sincronizadoFirebase: Boolean = false,
    val activo: Boolean = true
)
```

### **ğŸª TABLA MERCADILLOS (POR USUARIO):**
```kotlin
@Entity(tableName = "mercadillos")
data class MercadilloEntity(
    @PrimaryKey val id: String = UUID.randomUUID().toString(),
    
    // USUARIO PROPIETARIO
    val userId: String,                   // Usuario actual o "usuario_default"
    
    // DATOS DEL MERCADILLO
    val fechaHora: Long,
    val lugar: String,
    val organizador: String,
    val esGratis: Boolean = true,
    val estado: Int = 0,                  // Estados 0-7
    
    // CAMPOS OPCIONALES
    val turno: String? = null,
    val ubicacion: String? = null,
    val municipio: String? = null,
    val importeSuscripcion: Double = 0.0,
    val puntoDeLuz: Boolean = false,
    val requiereCarpa: Boolean = true,
    val requiereMesa: Boolean = true,
    val horaInicio: String? = null,
    val horaFin: String? = null,
    val saldoInicial: Double = 0.0,
    
    // SINCRONIZACIÃ“N V10
    val version: Long = 1,
    val lastModified: Long = System.currentTimeMillis(),
    val sincronizadoFirebase: Boolean = false
)
```

---

## ğŸ”‘ **LÃ“GICA DE USUARIOS V10**

### **Estados posibles:**
1. **Usuario logueado** â†’ `usuarioLogueado = "firebase_uid"`, `esPremium = true/false`
2. **Sin usuario** â†’ `usuarioLogueado = null`, `esPremium = false` (datos de usuario_default)

### **Reglas de Premium:**
- âœ… **Usuario_default** â†’ `esPremium = false` SIEMPRE
- âœ… **Usuario logueado** â†’ `esPremium = true/false` segÃºn su plan
- âœ… **Logout** â†’ Cambiar a usuario_default con `esPremium = false`

### **Permisos en ConfiguraciÃ³n:**
```kotlin
// TODOS (logueado o no)
- Cambiar tema oscuro âœ…

// SOLO PREMIUM
- Cambiar moneda âœ…
- Cambiar idioma âœ…  
- Cambiar fuente âœ…
```

---

## ğŸ”„ **SINCRONIZACIÃ“N V10 - MEJORADA**

### **ğŸ“Š Campos de sincronizaciÃ³n en TODAS las tablas:**
```kotlin
val version: Long = 1,                    // NÃºmero de versiÃ³n del registro
val lastModified: Long = timestamp,       // Timestamp Ãºltima modificaciÃ³n
val sincronizadoFirebase: Boolean = false // Pendiente de enviar a Firebase
```

### **ğŸš€ Estrategia de sincronizaciÃ³n:**
1. **Escritura**: Siempre en Room first
2. **Incrementar version** en cada modificaciÃ³n
3. **Actualizar lastModified** en cada cambio
4. **Marcar sincronizadoFirebase = false**
5. **Intentar sync a Firebase** en background
6. **Si success** â†’ `sincronizadoFirebase = true`
7. **Si fail** â†’ Queda pendiente hasta prÃ³xima conexiÃ³n

### **âš”ï¸ ResoluciÃ³n de conflictos:**
- **Last-write-wins** - El timestamp `lastModified` mÃ¡s reciente gana
- **Campo `version`** para detectar conflictos
- **Merge automÃ¡tico** sin intervenciÃ³n del usuario

---

## ğŸ“ **ESTRUCTURA V10 SIMPLIFICADA**

```
app/src/main/java/es/nuskysoftware/marketsales/
â”œâ”€â”€ MainActivity.kt âœ…
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”œâ”€â”€ dao/
â”‚   â”‚   â”‚   â”œâ”€â”€ ConfiguracionDao.kt ğŸ”„ (simplificar)
â”‚   â”‚   â”‚   â””â”€â”€ MercadilloDao.kt âœ… (agregar sync fields)
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”œâ”€â”€ ConfiguracionEntity.kt ğŸ”„ (nueva estructura)
â”‚   â”‚   â”‚   â””â”€â”€ MercadilloEntity.kt ğŸ”„ (agregar version/lastModified)
â”‚   â”‚   â””â”€â”€ database/
â”‚   â”‚       â””â”€â”€ AppDatabase.kt ğŸ”„ (v5, eliminar tabla usuarios)
â”‚   â””â”€â”€ repository/
â”‚       â”œâ”€â”€ ConfiguracionRepository.kt ğŸ”„ (simplificar)
â”‚       â”œâ”€â”€ AuthRepository.kt ğŸ”„ (refactorizar monousuario)
â”‚       â””â”€â”€ MercadilloRepository.kt âœ… (crear con sync)
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ theme/ âœ… (sin cambios)
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ MenuHamburguesa.kt ğŸ”„ (simplificar sin multiusuario)
â”‚   â”œâ”€â”€ pantallas/
â”‚   â”‚   â”œâ”€â”€ PantallaSplash.kt âœ…
â”‚   â”‚   â”œâ”€â”€ PantallaLogin.kt ğŸ”„ (simplificar)
â”‚   â”‚   â”œâ”€â”€ PantallaConfiguracion.kt ğŸ”„ (nueva lÃ³gica permisos)
â”‚   â”‚   â”œâ”€â”€ PantallaPerfil.kt ğŸ”„ (simplificar)
â”‚   â”‚   â””â”€â”€ PantallaMercadillos.kt âœ…
â”‚   â””â”€â”€ viewmodel/
â”‚       â”œâ”€â”€ ConfiguracionViewModel.kt ğŸ”„ (simplificar)
â”‚       â”œâ”€â”€ AuthViewModel.kt ğŸ”„ (refactorizar)
â”‚       â””â”€â”€ MercadilloViewModel.kt âœ… (crear)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ ConfigurationManager.kt ğŸ”„ (simplificar enormemente)
â”‚   â”œâ”€â”€ StringResourceManager.kt âœ…
â”‚   â”œâ”€â”€ GoogleAuthHelper.kt âœ…
â”‚   â”œâ”€â”€ EstadosMercadillo.kt âœ…
â”‚   â””â”€â”€ FooterMarca.kt âœ…
â””â”€â”€ sync/ âœ… (NUEVO)
    â”œâ”€â”€ SyncManager.kt âœ… (gestiÃ³n de sincronizaciÃ³n)
    â””â”€â”€ ConflictResolver.kt âœ… (resoluciÃ³n de conflictos)
```

---

## ğŸ”„ **MIGRACIÃ“N DE BASE DE DATOS V10**

### **De AppDatabase v4 â†’ v5:**
```kotlin
@Database(
    entities = [ConfiguracionEntity::class, MercadilloEntity::class],
    version = 5,
    exportSchema = false
)
abstract class AppDatabase : RoomDatabase() {
    abstract fun configuracionDao(): ConfiguracionDao
    abstract fun mercadilloDao(): MercadilloDao
    
    // MIGRATION 4 â†’ 5
    val MIGRATION_4_5 = object : Migration(4, 5) {
        override fun migrate(database: SupportSQLiteDatabase) {
            // 1. Eliminar tabla usuarios (no se necesita)
            database.execSQL("DROP TABLE IF EXISTS usuarios")
            
            // 2. Recrear tabla configuracion con nueva estructura
            database.execSQL("DROP TABLE IF EXISTS configuracion")
            database.execSQL("""
                CREATE TABLE configuracion (
                    id INTEGER PRIMARY KEY NOT NULL,
                    moneda TEXT NOT NULL DEFAULT 'â‚¬ Euro',
                    idioma TEXT NOT NULL DEFAULT 'es',
                    fuente TEXT NOT NULL DEFAULT 'Montserrat',
                    temaOscuro INTEGER NOT NULL DEFAULT 0,
                    usuarioLogueado TEXT,
                    esPremium INTEGER NOT NULL DEFAULT 0,
                    version INTEGER NOT NULL DEFAULT 1,
                    lastModified INTEGER NOT NULL DEFAULT 0,
                    pendienteSync INTEGER NOT NULL DEFAULT 0
                )
            """)
            
            // 3. Agregar campos de sync a mercadillos
            database.execSQL("ALTER TABLE mercadillos ADD COLUMN version INTEGER NOT NULL DEFAULT 1")
            database.execSQL("ALTER TABLE mercadillos ADD COLUMN lastModified INTEGER NOT NULL DEFAULT 0")
        }
    }
}
```

---

## ğŸ¯ **FUNCIONALIDADES V10**

### **âœ… ConfigurationManager simplificado:**
```kotlin
object ConfigurationManager {
    // CONFIGURACIÃ“N GLOBAL
    private val _moneda = MutableStateFlow("â‚¬ Euro")
    private val _idioma = MutableStateFlow("es") 
    private val _fuente = MutableStateFlow("Montserrat")
    private val _temaOscuro = MutableStateFlow(false)
    
    // USUARIO ACTUAL
    private val _usuarioLogueado = MutableStateFlow<String?>(null)
    private val _esPremium = MutableStateFlow(false)
    
    // Estados pÃºblicos
    val moneda: StateFlow<String> = _moneda.asStateFlow()
    val idioma: StateFlow<String> = _idioma.asStateFlow()
    val fuente: StateFlow<String> = _fuente.asStateFlow()
    val temaOscuro: StateFlow<Boolean> = _temaOscuro.asStateFlow()
    val esPremium: StateFlow<Boolean> = _esPremium.asStateFlow()
    
    // MÃ‰TODOS SIMPLIFICADOS
    fun login(userId: String, isPremium: Boolean) {
        _usuarioLogueado.value = userId
        _esPremium.value = isPremium
    }
    
    fun logout() {
        _usuarioLogueado.value = null
        _esPremium.value = false
    }
    
    fun canChangeConfiguration(): Boolean = _esPremium.value
    fun canChangeTheme(): Boolean = true // Todos pueden cambiar tema
}
```

### **âœ… AuthRepository simplificado:**
```kotlin
class AuthRepository(context: Context) {
    private val configuracionRepo = ConfiguracionRepository(context)
    
    suspend fun login(email: String, password: String): AuthResult {
        // 1. Autenticar con Firebase
        val result = firebaseAuth.signInWithEmailAndPassword(email, password).await()
        
        // 2. Cargar configuraciÃ³n con nuevo usuario
        val isPremium = checkUserPremiumStatus(result.user?.uid)
        configuracionRepo.setUsuarioLogueado(result.user?.uid, isPremium)
        
        // 3. Actualizar ConfigurationManager
        ConfigurationManager.login(result.user?.uid ?: "", isPremium)
        
        return AuthResult.Success(result.user)
    }
    
    suspend fun logout(): AuthResult {
        // 1. Logout Firebase
        firebaseAuth.signOut()
        
        // 2. Cambiar a usuario_default
        configuracionRepo.setUsuarioLogueado(null, false)
        
        // 3. Actualizar ConfigurationManager
        ConfigurationManager.logout()
        
        return AuthResult.Success(null)
    }
}
```

---

## ğŸ“‹ **TAREAS INMEDIATAS V10**

### **ğŸ”´ CRÃTICO - Eliminar archivos obsoletos:**
1. âŒ `MenuLateral.kt` - Eliminar completamente
2. âŒ `UserRepository.kt` - Eliminar
3. âŒ `UserDao.kt` - Eliminar  
4. âŒ `UserEntity.kt` - Eliminar
5. âŒ `UserManager.kt` - Eliminar

### **ğŸŸ¡ REFACTORIZAR archivos existentes:**
1. ğŸ”„ `ConfiguracionEntity.kt` - Nueva estructura simplificada
2. ğŸ”„ `ConfigurationManager.kt` - Eliminar 80% del cÃ³digo multiusuario
3. ğŸ”„ `AuthRepository.kt` - Simplificar flujo monousuario
4. ğŸ”„ `AppDatabase.kt` - MigraciÃ³n v4â†’v5, eliminar tabla usuarios
5. ğŸ”„ `PantallaConfiguracion.kt` - Nueva lÃ³gica de permisos Premium
6. ğŸ”„ `MenuHamburguesa.kt` - Simplificar sin roles/empresas

### **ğŸŸ¢ CREAR nuevos archivos:**
1. âœ… `MercadilloRepository.kt` - Con sistema de sincronizaciÃ³n
2. âœ… `MercadilloViewModel.kt` - Para PantallaMercadillos
3. âœ… `SyncManager.kt` - GestiÃ³n central de sincronizaciÃ³n
4. âœ… `ConflictResolver.kt` - ResoluciÃ³n automÃ¡tica de conflictos

---

## ğŸ”’ **REGLAS V10**

### **âœ… ConfiguraciÃ³n Global:**
- Moneda, idioma, fuente, tema â†’ Comunes a TODOS los usuarios
- Se guardan en tabla `configuracion` id=1
- Solo Premium puede cambiar (excepto tema)

### **âœ… Datos por Usuario:**
- Mercadillos, artÃ­culos, categorÃ­as, ventas â†’ Por `userId`
- Usuario logueado â†’ `firebase_uid`
- Sin usuario â†’ `"usuario_default"`

### **âœ… SincronizaciÃ³n:**
- SIEMPRE escribir en Room primero
- Sync a Firebase en background (no bloqueante)
- Last-write-wins para conflictos
- Cola de pendientes hasta recuperar conexiÃ³n

### **âœ… Premium:**
- Solo afecta permisos de configuraciÃ³n
- No afecta funcionalidad core de mercadillos
- Usuario_default â†’ Siempre FREE

---

## ğŸ“Š **ESTADO V10**

### **ğŸ—‘ï¸ Eliminaciones (20% del cÃ³digo):**
- Sistema multiusuario completo
- GestiÃ³n de empresas y roles
- Tabla usuarios
- ConfiguraciÃ³n por usuario

### **ğŸ”„ Refactorizaciones (60% del cÃ³digo):**
- ConfigurationManager simplificado
- AuthRepository monousuario
- Base de datos v5
- Pantallas actualizadas

### **âœ… Nuevas funcionalidades (20% del cÃ³digo):**
- Sistema de sincronizaciÃ³n mejorado
- ResoluciÃ³n de conflictos automÃ¡tica
- GestiÃ³n de versiones
- Cola de sincronizaciÃ³n

---

## ğŸ‰ **RESUMEN V10**

**Market Sales V10** representa una **refactorizaciÃ³n completa** hacia una arquitectura **monousuario simplificada**:

### **ğŸš€ Beneficios:**
- âœ… **CÃ³digo 60% mÃ¡s simple** - EliminaciÃ³n sistema multiusuario
- âœ… **Mejor rendimiento** - Menos complejidad en queries
- âœ… **SincronizaciÃ³n robusta** - Timestamp + versionado
- âœ… **UX mÃ¡s clara** - Premium solo para configuraciÃ³n avanzada
- âœ… **Mantenimiento reducido** - Arquitectura simplificada

### **ğŸ“± Funcionalidad mantenida:**
- âœ… AutenticaciÃ³n Firebase (simplificada)
- âœ… ConfiguraciÃ³n dinÃ¡mica (optimizada)
- âœ… GestiÃ³n de mercadillos (mejorada)
- âœ… Tema oscuro/claro
- âœ… LocalizaciÃ³n ES/EN

---

**VERSIÃ“N:** V10.0  
**FECHA:** Enero 2025  
**ESTADO:** ğŸ”„ **REFACTORIZACIÃ“N EN CURSO - ARQUITECTURA MONOUSUARIO**

---

## ğŸ“ **PRÃ“XIMOS PASOS V10.1**

1. **ELIMINAR** archivos obsoletos identificados
2. **REFACTORIZAR** ConfigurationManager (eliminar 80% cÃ³digo multiusuario)  
3. **CREAR** migraciÃ³n AppDatabase v4â†’v5
4. **ACTUALIZAR** PantallaConfiguracion con nueva lÃ³gica permisos
5. **IMPLEMENTAR** MercadilloRepository con sincronizaciÃ³n
6. **TESTING** completo del flujo login/logout simplificado