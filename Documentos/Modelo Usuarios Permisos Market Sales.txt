# ğŸ—ï¸ **SISTEMA USUARIOS Y PERMISOS - MARKET SALES (CORREGIDO)**

## ğŸ“Š **MODELO DE DATOS CORREGIDO**

### **FREE vs PREMIUM - Diferencias Clave:**

#### **ğŸŸ¢ VERSIÃ“N FREE**
- **Usuarios:** âˆ usuarios independientes
- **Scope:** Cada usuario ve SOLO sus datos personales
- **Datos:** `empresaId = null` + `creadoPor = userId`
- **RelaciÃ³n:** Sin relaciÃ³n entre usuarios FREE

#### **ğŸŸ£ VERSIÃ“N PREMIUM** 
- **Usuarios:** MÃºltiples usuarios de UNA empresa
- **Scope:** Todos ven datos de la MISMA empresa (con permisos)
- **Datos:** `empresaId = "empresa_123"` (compartido)
- **RelaciÃ³n:** Usuarios colaboran en misma empresa

---

## ğŸ“Š **ESTRUCTURA DE DATOS CORREGIDA**

### **1. COLECCIÃ“N `usuarios` (ampliada)**
```javascript
// Documento: {userId}
{
  email: "juan@email.com",
  uid: "abc123",
  displayName: "Juan PÃ©rez",
  photoUrl: "https://...",
  fechaCreacion: timestamp,
  
  // âœ… CAMPOS PARA DETERMINAR SCOPE
  planUsuario: "FREE" | "PREMIUM",
  empresaId: null | "empresa_abc123",  // FREE: null, PREMIUM: empresaId
  
  // âœ… SOLO PARA PREMIUM
  tipoUsuario: null | "SUPER_ADMIN" | "ADMIN" | "EMPLEADO" | "INVITADO",
  permisos: null | {
    mercadillos: { crear: true, editar: true, eliminar: true, ver: true },
    articulos: { crear: true, editar: true, eliminar: false, ver: true },
    // ... otros mÃ³dulos
  },
  
  configuracion: {
    idioma: "es",
    fuente: "Montserrat", 
    modoOscuro: false
  },
  activo: true
}
```

### **2. DATOS CON SCOPE CORREGIDO**
```javascript
// Ejemplo: mercadillos/{mercadilloId}
{
  nombre: "Mercadillo Centro",
  descripcion: "...",
  fechaCreacion: timestamp,
  
  // âœ… SCOPE UNIVERSAL
  empresaId: null | "empresa_abc123",  // FREE: null, PREMIUM: empresaId
  creadoPor: "userId_abc123",          // Siempre presente
  
  // ... resto de campos
}
```

---

## ğŸ¯ **LÃ“GICA DE ACCESO CORREGIDA**

### **UserManager.kt (Corregido)**
```kotlin
object UserManager {
    
    fun getCurrentScope(): DataScope {
        val user = getCurrentUser()
        return when (user?.planUsuario) {
            "FREE" -> DataScope.Personal(user.uid)
            "PREMIUM" -> DataScope.Empresa(user.empresaId!!)
            else -> DataScope.Personal(user?.uid ?: "")
        }
    }
    
    sealed class DataScope {
        data class Personal(val userId: String) : DataScope()
        data class Empresa(val empresaId: String) : DataScope()
    }
}
```

### **Repository Pattern Corregido**
```kotlin
class MercadillosRepository {
    
    suspend fun getMercadillos(): List<Mercadillo> {
        val scope = UserManager.getCurrentScope()
        
        return when (scope) {
            is DataScope.Personal -> {
                // FREE: Solo mis datos personales
                firestore.collection("mercadillos")
                    .whereEqualTo("empresaId", null)
                    .whereEqualTo("creadoPor", scope.userId)
                    .get()
            }
            is DataScope.Empresa -> {
                // PREMIUM: Todos los datos de mi empresa
                firestore.collection("mercadillos")
                    .whereEqualTo("empresaId", scope.empresaId)
                    .get()
            }
        }
    }
    
    suspend fun createMercadillo(mercadillo: Mercadillo) {
        val scope = UserManager.getCurrentScope()
        val currentUser = FirebaseAuth.getInstance().currentUser!!
        
        val mercadilloData = mercadillo.copy(
            empresaId = when (scope) {
                is DataScope.Personal -> null
                is DataScope.Empresa -> scope.empresaId
            },
            creadoPor = currentUser.uid
        )
        
        firestore.collection("mercadillos").add(mercadilloData)
    }
}
```

---

## ğŸ”„ **FLUJOS DE USUARIO CORREGIDOS**

### **ğŸŸ¢ FLUJO FREE**
1. **Juan se registra FREE** â†’ Ve solo sus mercadillos
2. **MarÃ­a se registra FREE** â†’ Ve solo sus mercadillos  
3. **Pedro se registra FREE** â†’ Ve solo sus mercadillos
4. **Sin relaciÃ³n** entre Juan, MarÃ­a y Pedro

### **ğŸŸ£ FLUJO PREMIUM**
1. **Juan compra Premium** â†’ Se convierte en SUPER_ADMIN
2. **Juan crea empresa** â†’ Sus datos migran a `empresaId`
3. **Juan invita a MarÃ­a** â†’ MarÃ­a ve datos de la empresa
4. **Juan invita a Pedro** â†’ Pedro ve datos de la empresa  
5. **ColaboraciÃ³n** entre Juan, MarÃ­a y Pedro

---

## ğŸš€ **MIGRACIÃ“N FREE â†’ PREMIUM**

### **Antes (Usuario FREE)**
```javascript
// mercadillos/mercadillo1
{
  nombre: "Mi Mercadillo",
  empresaId: null,           // â† FREE
  creadoPor: "juan_123"
}
```

### **DespuÃ©s (Usuario PREMIUM)**
```javascript
// 1. Se actualiza el usuario
// usuarios/juan_123
{
  planUsuario: "PREMIUM",     // â† CambiÃ³ de FREE
  empresaId: "empresa_456",   // â† Nueva empresa
  tipoUsuario: "SUPER_ADMIN"
}

// 2. Se migran los datos existentes
// mercadillos/mercadillo1  
{
  nombre: "Mi Mercadillo",
  empresaId: "empresa_456",   // â† Migrado de null
  creadoPor: "juan_123"       // â† Mantiene creador original
}
```

---

## ğŸ” **FIRESTORE RULES CORREGIDAS**

```javascript
// Reglas que soportan FREE y PREMIUM
match /mercadillos/{mercadilloId} {
  allow read, write: if request.auth != null && (
    // CASO 1: Usuario FREE accede a sus datos personales
    (resource.data.empresaId == null && 
     resource.data.creadoPor == request.auth.uid) ||
     
    // CASO 2: Usuario PREMIUM accede a datos de su empresa
    (resource.data.empresaId != null && 
     get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.empresaId == resource.data.empresaId &&
     get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.planUsuario == "PREMIUM")
  );
}
```

---

## âœ… **VENTAJAS DEL MODELO CORREGIDO**

### **ğŸ¯ Flexibilidad Total**
- **FREE:** Usuarios independientes (como ahora)
- **PREMIUM:** Usuarios colaborativos (nuevo)
- **MigraciÃ³n:** Sin pÃ©rdida de datos

### **ğŸ”§ Queries Eficientes**
- **FREE:** `empresaId == null AND creadoPor == userId`
- **PREMIUM:** `empresaId == "empresa_123"`
- **Un solo patrÃ³n:** Para todos los mÃ³dulos

### **ğŸ›¡ï¸ Seguridad Granular**
- **FREE:** Solo acceso a datos propios
- **PREMIUM:** Acceso con permisos por rol
- **Firestore Rules:** Previenen acceso cruzado

---

## ğŸ“± **UX DIFERENCIADA**

### **Usuario FREE**
```
Header: "Â¡Hola Juan!"
Datos: "Mis 3 mercadillos"
Upgrade: "ğŸš€ Upgrade a Premium para colaborar"
```

### **Usuario PREMIUM**
```  
Header: "Juan @ Mi Empresa SL"
Datos: "15 mercadillos del equipo"
GestiÃ³n: "ğŸ‘¥ Gestionar usuarios"
```

---

## ğŸ‰ **RESULTADO FINAL CORREGIDO**

### **FREE (MÃºltiples usuarios independientes)**
- âœ… **Infinitos usuarios** pueden registrarse
- âœ… **Cada uno ve solo** sus datos
- âœ… **Sin colaboraciÃ³n** entre usuarios
- âœ… **Mismo UX** que versiÃ³n actual

### **PREMIUM (Usuarios colaborativos)**
- âœ… **Un Super Admin** crea empresa
- âœ… **Invita usuarios** a colaborar  
- âœ… **Todos ven datos** de la empresa
- âœ… **Permisos granulares** por rol

Â¿Ahora sÃ­ refleja correctamente tu visiÃ³n del sistema? ğŸ¯

---

## ğŸ“± **PANTALLAS NUEVAS PREMIUM**

### **1. GestiÃ³n de Usuarios** (`PantallaUsuarios.kt`)
- Lista de usuarios de la empresa
- Crear/editar/desactivar usuarios
- Asignar permisos por mÃ³dulo
- Solo visible para SUPER_ADMIN y ADMIN

### **2. ConfiguraciÃ³n Empresa** (`PantallaEmpresa.kt`)
- Datos de la empresa
- ConfiguraciÃ³n global
- Plan y lÃ­mites
- Solo visible para SUPER_ADMIN

### **3. Selector de Contexto** (Widget)
- "Trabajando como: [Usuario Actual]"
- "Empresa: [Nombre Empresa]"
- Visible en header cuando es Premium

---

## ğŸ” **REGLAS DE SEGURIDAD FIRESTORE**

```javascript
// Regla para mercadillos
match /mercadillos/{mercadilloId} {
  allow read, write: if request.auth != null && (
    // FREE: Solo sus datos
    (resource.data.empresaId == null && resource.data.creadoPor == request.auth.uid) ||
    // PREMIUM: Datos de su empresa + permisos
    (resource.data.empresaId != null && 
     get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.empresaId == resource.data.empresaId &&
     get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.permisos.mercadillos.ver == true)
  );
}
```

---

## âœ… **VENTAJAS DE ESTA ARQUITECTURA**

### **ğŸ¯ Simplicidad**
- **FREE:** Funciona igual que ahora (sin cambios)
- **PREMIUM:** Solo agrega `empresaId` y permisos
- **MigraciÃ³n:** AutomÃ¡tica y transparente

### **ğŸ”§ Eficiencia**
- **Queries mÃ­nimos:** Un filtro por `empresaId`
- **Permisos en memoria:** Cargados una vez al login
- **Escalable:** Soporta miles de usuarios

### **ğŸ›¡ï¸ Seguridad**
- **Firestore Rules:** Previenen acceso no autorizado
- **UserManager:** Controla permisos en UI
- **Tokens JWT:** ValidaciÃ³n server-side

---

## ğŸ“‹ **PLAN DE IMPLEMENTACIÃ“N**

### **Fase 1: FundaciÃ³n (1 semana)**
1. âœ… Crear `UserManager.kt`
2. âœ… Ampliar `usuarios` collection
3. âœ… Crear `empresas` collection
4. âœ… Modificar `AuthRepository` para cargar permisos

### **Fase 2: Repositorios (1 semana)**  
1. âœ… Modificar repositorios para scope
2. âœ… Implementar filtros FREE/PREMIUM
3. âœ… Testing de queries con permisos

### **Fase 3: UI Premium (1 semana)**
1. âœ… `PantallaUsuarios.kt`
2. âœ… `PantallaEmpresa.kt` 
3. âœ… Integrar permisos en pantallas existentes

### **Fase 4: MigraciÃ³n y Testing (1 semana)**
1. âœ… Flujo FREE â†’ PREMIUM
2. âœ… Invitaciones de usuarios
3. âœ… Testing completo

---

## ğŸ‰ **RESULTADO FINAL**

### **Experiencia FREE (sin cambios)**
- Usuario trabaja con sus datos personales
- Misma UX que ahora
- OpciÃ³n de upgrade visible

### **Experiencia PREMIUM**
- Super Admin crea empresa y usuarios  
- Empleados ven solo datos de empresa
- Permisos granulares por mÃ³dulo
- GestiÃ³n centralizada

**Â¿Te parece bien esta arquitectura? Â¿Empezamos con la Fase 1?** ğŸš€